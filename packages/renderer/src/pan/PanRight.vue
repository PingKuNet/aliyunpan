<script setup lang="ts">
import { IAliGetFileModel } from '@/aliapi/alimodels'
import { KeyboardState, useAppStore, useKeyboardStore, usePanFileStore, useSettingStore } from '@/store'
import useWinStore from '@/store/winstore'
import { onShowRightMenu, RefreshScroll, RefreshScrollTo, TestCtrl, TestCtrlShift, TestKey, TestKeyboardScroll, TestKeyboardSelect, onHideRightMenuScroll } from '@/utils/keyboardhelper'
import { onMounted, reactive, ref } from 'vue'
import PanDAL from './pandal'
import _ from 'lodash'

import { Tooltip as AntdTooltip } from 'ant-design-vue'
import 'ant-design-vue/es/tooltip/style/css'

import { handleUpload, topFavorDeleteAll, menuFavSelectFile, menuTrashSelectFile, menuCopySelectedFile, menuCreatShare, topSearchAll, dropMoveSelectedFile } from './topbtns/topbtn'
import { modalCreatNewFile, modalCreatNewDir, modalRename, modalDaoRuShareLink } from '@/utils/modal'
import { PanFileState } from './panfilestore'
import PanTopbtn from './menus/PanTopbtn.vue'
import FileTopbtn from './menus/FileTopbtn.vue'
import FileRightMenu from './menus/FileRightMenu.vue'
import TrashRightMenu from './menus/TrashRightMenu.vue'
import TrashTopbtn from './menus/TrashTopbtn.vue'
import DirTopPath from './menus/DirTopPath.vue'
import message from '@/utils/message'
import { menuOpenFile } from '@/utils/openfile'
import UserDAL from '@/user/userdal'

const viewlist = ref()
const inputsearch = ref()

const appStore = useAppStore()
const winStore = useWinStore()
const panfileStore = usePanFileStore()

let dirid = ''
panfileStore.$subscribe((_m: any, state: PanFileState) => {
  if (state.DirID != dirid) {
    dirid = state.DirID
    RefreshScrollTo(viewlist.value.$el, 0)
  }
  let isTrash = panfileStore.SelectDirType == 'trash' || panfileStore.SelectDirType == 'recover'
  menuShowVideo.value = !isTrash && panfileStore.ListSelected.size == 1 && panfileStore.GetSelectedFirst()?.category == 'video'
  menuShowZip.value = !isTrash && panfileStore.ListSelected.size == 1 && (panfileStore.GetSelectedFirst()?.ext == 'zip' || panfileStore.GetSelectedFirst()?.ext == 'rar')
})

const keyboardStore = useKeyboardStore()
keyboardStore.$subscribe((_m: any, state: KeyboardState) => {
  if (appStore.appTab != 'pan') return

  if (TestCtrl('a', state.KeyDownEvent, () => panfileStore.mSelectAll())) return
  if (TestCtrl('c', state.KeyDownEvent, () => menuCopySelectedFile(false, 'copy'))) return
  if (TestCtrl('x', state.KeyDownEvent, () => menuCopySelectedFile(false, 'cut'))) return
  if (TestCtrlShift('Delete', state.KeyDownEvent, () => menuTrashSelectFile(false, true))) return
  if (TestCtrl('Delete', state.KeyDownEvent, () => menuTrashSelectFile(false, false))) return
  if (
    TestCtrlShift('f', state.KeyDownEvent, () => {
      PanDAL.aShowDir('', 'search', false)
      setTimeout(() => {
        let doc = document.getElementById('searchpan')?.getElementsByTagName('INPUT')[0] as any
        doc.focus()
      }, 300)
    })
  )
    return 
  if (TestCtrl('f', state.KeyDownEvent, () => inputsearch.value.focus())) return 
  if (TestKey('f3', state.KeyDownEvent, () => inputsearch.value.focus())) return 
  if (TestKey(' ', state.KeyDownEvent, () => inputsearch.value.focus())) return 
  if (TestCtrlShift('n', state.KeyDownEvent, () => modalCreatNewDir('folder'))) return 
  if (TestCtrl('n', state.KeyDownEvent, modalCreatNewFile)) return 
  if (TestCtrlShift('u', state.KeyDownEvent, () => handleUpload('folder'))) return 
  if (TestCtrl('u', state.KeyDownEvent, () => handleUpload('file'))) return 
  if (TestCtrl('l', state.KeyDownEvent, modalDaoRuShareLink)) return 
  if (TestKey('f5', state.KeyDownEvent, handleRefresh)) return 
  if (TestKey('Backspace', state.KeyDownEvent, handleBack)) return 
  if (TestKey('f2', state.KeyDownEvent, () => modalRename(false, panfileStore.IsListSelectedMulti))) return 
  if (TestCtrl('e', state.KeyDownEvent, () => modalRename(false, panfileStore.IsListSelectedMulti))) return 
  if (TestCtrl('s', state.KeyDownEvent, () => menuCreatShare(false, 'pan'))) return 
  if (TestCtrl('g', state.KeyDownEvent, () => menuFavSelectFile(false, !panfileStore.IsListSelectedFavAll))) return 
  if (TestCtrl('q', state.KeyDownEvent, onSelectRangStart)) return 
  if (TestKeyboardScroll(state.KeyDownEvent, viewlist.value, panfileStore)) return 
  if (TestKeyboardSelect(state.KeyDownEvent, viewlist.value, panfileStore, handleOpenFile)) return 
})

const handleRefresh = () => PanDAL.aShowDir('', 'refresh', false)
const handleBack = () => PanDAL.aShowDir('', 'back', false)
const handleSelectAll = () => panfileStore.mSelectAll()
const handleOrder = (order: string) => panfileStore.mOrderListData(order)
const handleSelect = (file_id: string, event: any) => {
  onHideRightMenuScroll()

  if (rangIsSelecting.value) {
    
    if (!rangSelectID.value) {
      
      
      if (!panfileStore.ListSelected.has(file_id)) panfileStore.mMouseSelect(file_id, true, false)
      rangSelectID.value = file_id
      rangSelectStart.value = file_id
      rangSelectFiles.value = { [file_id]: true }
    } else {
      
      const start = rangSelectID.value
      const children = panfileStore.ListDataShow
      let a = -1
      let b = -1
      for (let i = 0, maxi = children.length; i < maxi; i++) {
        if (children[i].file_id == file_id) a = i
        if (children[i].file_id == start) b = i
        if (a > 0 && b > 0) break
      }
      const filelist: string[] = []
      if (a >= 0 && b >= 0) {
        if (a > b) [a, b] = [b, a] 
        for (let n = a; n <= b; n++) {
          filelist.push(children[n].file_id)
        }
      }
      panfileStore.mRangSelect(file_id, filelist)
      rangIsSelecting.value = false
      rangSelectID.value = ''
      rangSelectStart.value = ''
      rangSelectEnd.value = ''
      rangSelectFiles.value = {}
    }
    panfileStore.mRefreshListDataShow(false) 
  } else {
    panfileStore.mMouseSelect(file_id, event.ctrlKey, event.shiftKey)
  }
}
const handleOpenFile = (event: Event, file: IAliGetFileModel | undefined) => {
  if (rangIsSelecting.value) return 
  if (panfileStore.DirID == 'trash' || panfileStore.DirID == 'recover') {
    return 
  }
  if (!file) file = panfileStore.GetSelectedFirst()
  if (!file) return

  if (file.isdir) {
    
    PanDAL.aShowDir('', file.compilation_id ? 'video' + file.name : file.file_id, true)
    return
  }
  
  if (!panfileStore.ListSelected.has(file.file_id)) panfileStore.mMouseSelect(file.file_id, false, false)

  menuOpenFile(file) 
}

const handleSearchInput = (value: string) => {
  panfileStore.mSearchListData(value)
  RefreshScrollTo(viewlist.value.$el, 0)
}
const handleSearchEnter = (event: any) => {
  event.target.blur()
  RefreshScroll(viewlist.value.$el)
}

const menuShowVideo = ref(false)
const menuShowZip = ref(false)
const handleRightClick = (e: { event: MouseEvent; node: any }) => {
  let key = e.node.key
  
  if (!panfileStore.ListSelected.has(key)) panfileStore.mMouseSelect(key, false, false)
  let dirtype = panfileStore.SelectDirType
  onShowRightMenu(dirtype == 'trash' || dirtype == 'recover' ? 'rightpantrashmenu' : 'rightpanmenu', e.event.clientX, e.event.clientY)
}

const handleFileListOrder = (order: string) => {
  panfileStore.mOrderListData(order)
}


let listGridWidth = 0
const resizeObserver = new ResizeObserver((entries) => {
  entries.map((t) => {
    listGridWidth = t.contentRect?.width || 0
  })
  onGridResize()
})
const onGridResize = _.debounce(
  () => {
    handleListGridMode(listGridMode.value)
  },
  20,
  { maxWait: 20 }
)
onMounted(() => {
  resizeObserver.observe(document.getElementById('panfilelist')!)
})

const listGridMode = ref('list')
const listGridColumn = ref(1)
const listGridItemHeight = ref(50)
const handleListGridMode = (mode: string) => {
  listGridMode.value = mode
  if (mode == 'list') {
    if (listGridItemHeight.value != 50) {
      listGridItemHeight.value = 50
      listGridColumn.value = 1
    }
  } else if (mode == 'image') {
    let count = Math.max(3, Math.floor(listGridWidth / 150))
    if (listGridItemHeight.value != 180) listGridItemHeight.value = 180
    if (listGridColumn.value != count) listGridColumn.value = count
  } else {
    let count = Math.max(2, Math.floor(listGridWidth / 200))
    if (listGridItemHeight.value != 180) listGridItemHeight.value = 240
    if (listGridColumn.value != count) listGridColumn.value = count
  }
  useSettingStore().updateStore({ uiFileListMode: mode }) 
  panfileStore.mGridListData(listGridMode.value, listGridColumn.value)
}


const rangIsSelecting = ref(false)
const rangSelectID = ref('')
const rangSelectStart = ref('')
const rangSelectEnd = ref('')
const rangSelectFiles = ref<{ [k: string]: any }>({})

const onSelectRangStart = () => {
  onHideRightMenuScroll()
  rangIsSelecting.value = !rangIsSelecting.value
  rangSelectID.value = ''
  rangSelectStart.value = ''
  rangSelectEnd.value = ''
  rangSelectFiles.value = {}
  panfileStore.mRefreshListDataShow(false) 
}

const onSelectRang = (file_id: string) => {
  if (rangIsSelecting.value && rangSelectID.value != '') {
    
    let startid = rangSelectID.value
    let endid = ''
    const s: { [k: string]: any } = {}
    const children = panfileStore.ListDataShow
    let a = -1
    let b = -1
    for (let i = 0, maxi = children.length; i < maxi; i++) {
      if (children[i].file_id == file_id) a = i
      if (children[i].file_id == startid) b = i
      if (a > 0 && b > 0) break
    }
    if (a >= 0 && b >= 0) {
      if (a > b) {
        ;[a, b] = [b, a] 
        endid = file_id
      } else {
        endid = startid
        startid = file_id
      }
      for (let n = a; n <= b; n++) {
        s[children[n].file_id] = true
      }
    }

    rangSelectStart.value = startid
    rangSelectEnd.value = endid
    rangSelectFiles.value = s
    panfileStore.mRefreshListDataShow(false) 
  }
}

const dragingRowItem = ref(false)
const onRowItemDragStart = (ev: any, file_id: string) => {
  console.log(ev, file_id)
  if (rangIsSelecting.value) {
    ev.stopPropagation()
    ev.preventDefault()
    return
  }

  onHideRightMenuScroll()
  dragingRowItem.value = true
  
  if (!panfileStore.ListSelected.has(file_id)) panfileStore.mMouseSelect(file_id, false, false)
  const files = panfileStore.GetSelected()

  const dragImage = document.createElement('div')
  dragImage.className = 'dragrowitem'
  if (files.length == 1) {
    dragImage.innerHTML = '<a>移动</a>' + files[0].name
  } else {
    dragImage.innerHTML = '<a>批量移动</a>' + files[0].name + ' 等(' + files.length.toString() + '个文件)'
  }

  if (ev.dataTransfer) {
    console.log('dragImage')
    document.body.appendChild(dragImage)
    ev.dataTransfer.setDragImage(dragImage, -16, 10)
    ev.dataTransfer.dropEffect = 'move'
    setTimeout(() => document.body.removeChild(dragImage), 0)
  }
}
const onRowItemDragEnter = (ev: any) => {
  if (dragingRowItem.value) {
    ev.stopPropagation()
    ev.preventDefault()
    ev.target.style.outline = '2px dotted #637dff'
    ev.target.style.background = 'rgba(var(--primary-6),0.3)'
    ev.dataTransfer.dropEffect = 'move'
  }
}
const onRowItemDragLeave = (ev: any) => {
  if (dragingRowItem.value) {
    ev.stopPropagation()
    ev.preventDefault()
    ev.target.style.outline = 'none'
    ev.target.style.background = ''
  }
}
const onRowItemDragOver = (ev: any) => {
  if (dragingRowItem.value) {
    ev.stopPropagation()
    ev.preventDefault() 
  }
}
const onRowItemDrop = (ev: any, movetodirid: string) => {
  ev.stopPropagation()
  ev.preventDefault() 
  ev.target.style.outline = 'none'
  ev.target.style.background = ''
  dropMoveSelectedFile(movetodirid)
}
const onRowItemDragEnd = (ev: any) => {
  if (dragingRowItem.value) {
    ev.stopPropagation()
    ev.preventDefault()
    dragingRowItem.value = false
  }
}


const showDragUpload = ref(false)
const onPanDrop = (e: any) => {
  console.log('onPanDrop', e)

  if (!e.dataTransfer.files || e.dataTransfer.files.length == 0) return
  e.stopPropagation()
  e.preventDefault() 
  showDragUpload.value = false

  if (panfileStore.DirID.startsWith('color')) {
    message.error('不能把文件上传到颜色标记里！请先选择一个网盘里的文件夹')
  }
  if (panfileStore.DirID.startsWith('search')) {
    message.error('不能把文件上传到搜索结果里！请先选择一个网盘里的文件夹')
  }
  if (panfileStore.DirID == 'favorite') {
    message.error('不能把文件上传到收藏里！请先选择一个网盘里的文件夹')
  }
  if (panfileStore.DirID == 'recover') {
    message.error('不能把文件上传到文件恢复里！请先选择一个网盘里的文件夹')
  }
  if (panfileStore.DirID == 'trash') {
    message.error('不能把文件上传到回收站里！请先选择一个网盘里的文件夹')
  }
  if (panfileStore.DirID.length != 40 && panfileStore.DirID != 'root') {
    message.error('错误的上传位置！请先选择一个网盘里的文件夹')
    return
  }

  
  const fileslist = e.dataTransfer.files
  if (fileslist && fileslist.length > 0) {
    const files: string[] = []
    
    for (let i = 0, maxi = fileslist.length; i < maxi; i++) {
      const path = fileslist[i].path
      files.push(path)
    }
    message.warning('上传' + files[0])
    //UploadDAL.UploadLocalFiles(UserDAL.QueryUserID(), this.props.pandir.selectDir.drive_id, this.props.pandir.selectDir.file_id, files, true) 
  }
}
const onPanDragEnter = (ev: any) => {
  if (dragingRowItem.value) return
  ev.stopPropagation()
  ev.preventDefault()
  ev.dataTransfer.dropEffect = 'copy'
  showDragUpload.value = true
}
const onPanDragLeave = (ev: any) => {
  ev.stopPropagation()
  ev.preventDefault()
  showDragUpload.value = false
}
const onPanDragOver = (ev: any) => {
  ev.stopPropagation()
  ev.preventDefault() 
}
const onPanDragEnd = (ev: any) => {
  if (showDragUpload.value) {
    ev.stopPropagation()
    ev.preventDefault()
    showDragUpload.value = false
  }
}
</script>

<template>
  <div style="height: 7px"></div>
  <div class="toppanbtns" style="height: 26px">
    <DirTopPath />
  </div>
  <div style="height: 14px"></div>
  <div class="toppanbtns" style="height: 26px" tabindex="-1">
    <div class="toppanbtn">
      <a-button type="text" size="small" tabindex="-1" :disabled="panfileStore.ListLoading" @click="handleBack" title="后退 Back Space">
        <template #icon>
          <i class="iconfont iconarrow-left-2-icon" />
        </template>
      </a-button>
      <a-button type="text" size="small" tabindex="-1" :loading="panfileStore.ListLoading" @click="handleRefresh" title="刷新 F5">
        <template #icon>
          <i class="iconfont iconreload-1-icon" />
        </template>
      </a-button>
    </div>
    <div class="toppanbtn" v-show="panfileStore.SelectDirType == 'favorite'">
      <a-button type="text" size="small" tabindex="-1" @click="topFavorDeleteAll" class="danger"><i class="iconfont iconcrown2" />清空收藏夹</a-button>
    </div>
    <div class="toppanbtn" v-show="panfileStore.SelectDirType == 'search' && !panfileStore.IsListSelected">
      <a-input-search
        id="searchpan"
        class="searchpan"
        style="width: 240px"
        :loading="panfileStore.ListLoading"
        placeholder="输入关键字，搜索整个网盘"
        button-text="搜索"
        search-button
        @search="(val:string)=>topSearchAll(val)"
        @press-enter="($event:any)=>topSearchAll($event.srcElement.value as string)"
        @keydown.esc="($event.target as any).blur()"
      />
      <a-button type="text" size="small" tabindex="-1" @click="() => topSearchAll('topSearchAll高级搜索')" style="border: none">高级搜索</a-button>
    </div>

    <PanTopbtn :dirtype="panfileStore.SelectDirType" :isselected="panfileStore.IsListSelected" />
    <FileTopbtn :dirtype="panfileStore.SelectDirType" :isselected="panfileStore.IsListSelected" :isvideo="menuShowVideo" :isselectedmulti="panfileStore.IsListSelectedMulti" :isallfavored="panfileStore.IsListSelectedFavAll" />
    <TrashTopbtn :dirtype="panfileStore.SelectDirType" :isselected="panfileStore.IsListSelected" />

    <div style="flex-grow: 1"></div>
    <div class="toppanbtn">
      <a-input-search
        :input-attrs="{ tabindex: '-1' }"
        ref="inputsearch"
        size="small"
        title="Ctrl+F / F3 / Space"
        placeholder="快速筛选"
        draggable="false"
        @dragenter.stop="() => false"
        :model-value="panfileStore.ListSearchKey"
        @input="(val:any)=>handleSearchInput(val as string)"
        @press-enter="handleSearchEnter"
        @keydown.esc="($event.target as any).blur()"
      />
    </div>
    <div></div>
  </div>
  <div style="height: 9px"></div>
  <div class="toppanarea" tabindex="-1">
    <div style="margin: 0 3px">
      <AntdTooltip title="点击全选" placement="left">
        <a-button shape="circle" type="text" tabindex="-1" class="select all" @click="handleSelectAll" title="Ctrl+A">
          <i :class="panfileStore.IsListSelectedAll ? 'iconfont iconrsuccess' : 'iconfont iconrpic'" />
        </a-button>
      </AntdTooltip>
    </div>
    <div class="selectInfo">{{ panfileStore.ListDataSelectCountInfo }}</div>
    <div style="margin: 0 2px">
      <AntdTooltip placement="rightTop">
        <a-button shape="square" type="text" tabindex="-1" class="qujian" :status="rangIsSelecting ? 'danger' : 'normal'" @click="onSelectRangStart" title="Ctrl+Q">
          {{ rangIsSelecting ? '取消选择' : '区间选择' }}
        </a-button>
        <template #title>
          <div>
            第1步: 点击 区间选择 这个按钮
            <br />
            第2步: 鼠标点击一个文件
            <br />
            第3步: 移动鼠标点击另外一个文件
          </div>
        </template>
      </AntdTooltip>
    </div>
    <div style="flex-grow: 1"></div>
    <div class="fileorder">
      <a-dropdown @select="(val:any)=>handleFileListOrder(val as string)" trigger="hover" position="bl" tabindex="-1">
        <a-button type="text" size="small" tabindex="-1" :disabled="panfileStore.ListLoading"><i class="iconfont iconpaixu1" />{{ panfileStore.FileOrderDesc }} <i class="iconfont icondown" /></a-button>

        <template #content>
          <a-doption value="name asc">
            <template #default>　名称 · 升序　</template>
          </a-doption>
          <a-doption value="name desc">
            <template #default>　名称 · 降序　</template>
          </a-doption>
          <a-doption value="updated_at asc">
            <template #default>　时间 · 升序　</template>
          </a-doption>
          <a-doption value="updated_at desc">
            <template #default>　时间 · 降序　</template>
          </a-doption>
          <a-doption value="size asc">
            <template #default>　大小 · 升序　</template>
          </a-doption>
          <a-doption value="size desc">
            <template #default>　大小 · 降序　</template>
          </a-doption>
        </template>
      </a-dropdown>
    </div>
    <div>
      <AntdTooltip title="列表模式" placement="bottom">
        <a-button shape="square" type="text" tabindex="-1" class="select" @click="() => handleListGridMode('list')">
          <i class="iconfont iconliebiaomoshi" />
        </a-button>
      </AntdTooltip>
      <AntdTooltip title="缩略图模式" placement="bottom">
        <a-button shape="square" type="text" tabindex="-1" class="select" @click="() => handleListGridMode('image')">
          <i class="iconfont iconxiaotumoshi" />
        </a-button>
      </AntdTooltip>
      <AntdTooltip title="大图模式" placement="bottom">
        <a-button shape="square" type="text" tabindex="-1" class="select" @click="() => handleListGridMode('bigimage')">
          <i class="iconfont iconsuoluetumoshi" />
        </a-button>
      </AntdTooltip>
    </div>
    <div class="cell pr"></div>
  </div>
  <div id="panfilelist" :class="'toppanlist' + (showDragUpload ? ' pandraging' : '') + (dragingRowItem ? ' draging' : '') + (rangIsSelecting ? ' ranging' : '')" @keydown.space.prevent="() => true" tabindex="-1" @drop="onPanDrop" @dragenter="onPanDragEnter">
    <a-list
      v-if="listGridMode == 'list'"
      ref="viewlist"
      :bordered="false"
      :split="false"
      :max-height="winStore.GetListHeightNumber"
      :virtualListProps="{
        height: winStore.GetListHeightNumber,
        isStaticItemHeight: true,
        estimatedItemHeight: 50,
        threshold: 1,
        itemKey: 'file_id'
      }"
      style="width: 100%"
      :data="panfileStore.ListDataShow"
      tabindex="-1"
      @scroll="onHideRightMenuScroll"
    >
      <template #item="{ item, index }">
        <div :key="'l-' + item.file_id" class="listitemdiv" :data-id="item.file_id">
          <div
            v-if="item.isdir"
            :class="'fileitem' + (panfileStore.ListSelected.has(item.file_id) ? ' selected' : '') + (panfileStore.ListFocusKey == item.file_id ? ' focus' : '')"
            @click="handleSelect(item.file_id, $event)"
            @mouseover="onSelectRang(item.file_id)"
            @contextmenu="(event:MouseEvent)=>handleRightClick({event,node:{key:item.file_id}} )"
            draggable="true"
            @dragstart="(ev) => onRowItemDragStart(ev, item.file_id)"
            @dragend="onRowItemDragEnd"
            @drop="onRowItemDrop($event, item.file_id)"
            @dragover="onRowItemDragOver"
            @dragenter="onRowItemDragEnter"
            @dragleave="onRowItemDragLeave"
          >
            <div :class="'rangselect ' + (rangSelectFiles[item.file_id] ? (rangSelectStart == item.file_id ? 'rangstart' : rangSelectEnd == item.file_id ? 'rangend' : 'rang') : '')">
              <a-button shape="circle" type="text" tabindex="-1" class="select" :title="index" @click.prevent.stop="handleSelect(item.file_id, { ctrlKey: true, shiftKey: false })">
                <i :class="panfileStore.ListSelected.has(item.file_id) ? (item.starred ? 'iconfont iconcrown3' : 'iconfont iconrsuccess') : item.starred ? 'iconfont iconcrown' : 'iconfont iconrpic'" />
              </a-button>
            </div>
            <div class="fileicon">
              <i :class="'iconfont ' + item.icon" aria-hidden="true"></i>
            </div>
            <div class="filename" droppable="false">
              <div :class="'filecolor ' + item.description" @click="handleOpenFile($event, item)">
                {{ item.name }}
              </div>
            </div>
            <div class="filebtn">
              <a-popover v-if="item.thumbnail" content-class="popimg" position="lt">
                <a-button type="text" tabindex="-1" class="gengduo">
                  <i class="iconfont icongengduo" />
                </a-button>
                <template #content>
                  <div class="preimg">
                    <img :src="item.thumbnail" />
                  </div>
                </template>
              </a-popover>
            </div>

            <div class="filesize">{{ item.sizestr }}</div>
            <div class="filetime">{{ item.timestr }}</div>
          </div>

          <div
            v-else
            :class="'fileitem' + (panfileStore.ListSelected.has(item.file_id) ? ' selected' : '') + (panfileStore.ListFocusKey == item.file_id ? ' focus' : '')"
            @click="handleSelect(item.file_id, $event)"
            @mouseover="onSelectRang(item.file_id)"
            @contextmenu="(event:MouseEvent)=>handleRightClick({event,node:{key:item.file_id}} )"
            draggable="true"
            @dragstart="(ev) => onRowItemDragStart(ev, item.file_id)"
            @dragend="onRowItemDragEnd"
          >
            <div :class="'rangselect ' + (rangSelectFiles[item.file_id] ? (rangSelectStart == item.file_id ? 'rangstart' : rangSelectEnd == item.file_id ? 'rangend' : 'rang') : '')">
              <a-button shape="circle" type="text" tabindex="-1" class="select" :title="index" @click.prevent.stop="handleSelect(item.file_id, { ctrlKey: true, shiftKey: false })">
                <i :class="panfileStore.ListSelected.has(item.file_id) ? (item.starred ? 'iconfont iconcrown3' : 'iconfont iconrsuccess') : item.starred ? 'iconfont iconcrown' : 'iconfont iconrpic'" />
              </a-button>
            </div>
            <div class="fileicon">
              <i :class="'iconfont ' + item.icon" aria-hidden="true"></i>
            </div>
            <div class="filename" droppable="false">
              <div :class="'filecolor ' + item.description" @click="handleOpenFile($event, item)">
                {{ item.name }}
              </div>
            </div>
            <div class="filebtn">
              <a-popover v-if="item.thumbnail" content-class="popimg" position="lt">
                <a-button type="text" tabindex="-1" class="gengduo">
                  <i class="iconfont icongengduo" />
                </a-button>
                <template #content>
                  <div class="preimg">
                    <img :src="item.thumbnail" />
                  </div>
                </template>
              </a-popover>
            </div>

            <div class="filesize">{{ item.sizestr }}</div>
            <div class="filetime">{{ item.timestr }}</div>
          </div>
        </div>
      </template>
    </a-list>

    <a-list
      v-else-if="listGridMode == 'image'"
      ref="viewlist"
      :bordered="false"
      :split="false"
      :max-height="winStore.GetListHeightNumber"
      :virtualListProps="{
        height: winStore.GetListHeightNumber,
        isStaticItemHeight: true,
        estimatedItemHeight: 200,
        threshold: 1,
        itemKey: 'file_id'
      }"
      style="width: 100%"
      :data="panfileStore.ListDataGrid"
      tabindex="-1"
      @scroll="onHideRightMenuScroll"
    >
      <template #item="{ item, index }">
        <div :key="'g-' + item.file_id" class="listitemdiv" :data-id="item.file_id">
          <div class="gridrow" :style="{ gridTemplateColumns: 'repeat(' + listGridColumn + ', 150px)' }">
            <template v-for="(grid, gindex) in item.files">
              <div
                v-if="grid.isdir"
                :class="'griditem ' + listGridMode + ' ' + (panfileStore.ListSelected.has(grid.file_id) ? ' selected' : '') + (panfileStore.ListFocusKey == grid.file_id ? ' focus' : '')"
                @click="handleSelect(grid.file_id, $event)"
                @mouseover="() => onSelectRang(grid.file_id)"
                @contextmenu="(event:MouseEvent)=>handleRightClick({event,node:{key:grid.file_id}} )"
                draggable="true"
                @dragstart="(ev) => onRowItemDragStart(ev, grid.file_id)"
                @dragend="onRowItemDragEnd"
                @drop="onRowItemDrop($event, grid.file_id)"
                @dragover="onRowItemDragOver"
                @dragenter="onRowItemDragEnter"
                @dragleave="onRowItemDragLeave"
              >
                <div class="gridicon">
                  <i :class="'iconfont ' + grid.icon" aria-hidden="true" role="img"></i>
                </div>
                <div class="gridicon"><img v-if="grid.thumbnail" :src="grid.thumbnail" @error="(e) => {(e.currentTarget! as any).style.display = 'none'}" /></div>

                <div class="gridicon">
                  <span v-if="grid.category.startsWith('video')" class="playicon" @click="handleOpenFile($event, grid)">
                    <svg viewBox="0 0 1024 1024">
                      <path d="M689.066667 480l-196.266667-177.066667c-27.733333-25.6-70.4-6.4-70.4 32v356.266667c0 36.266667 44.8 55.466667 70.4 32l196.266667-177.066667c17.066667-19.2 17.066667-49.066667 0-66.133333z"></path>
                    </svg>
                  </span>
                  <span v-else></span>
                </div>

                <div class="gridname">
                  <div @click="handleOpenFile($event, grid)" :class="'filecolor ' + grid.description" :title="grid.sizestr + ' ' + grid.name">
                    {{ grid.name }}
                  </div>
                </div>

                <div class="gridinfo">{{ grid.timestr }}</div>

                <div :class="'rangselect ' + (rangSelectFiles[grid.file_id] ? (rangSelectStart == grid.file_id ? 'rangstart' : rangSelectEnd == grid.file_id ? 'rangend' : 'rang') : '')">
                  <a-button shape="circle" type="text" tabindex="-1" class="select" :title="index * listGridColumn + gindex" @click.prevent.stop="handleSelect(grid.file_id, { ctrlKey: true, shiftKey: false })">
                    <i :class="panfileStore.ListSelected.has(grid.file_id) ? (grid.starred ? 'iconfont iconcrown3' : 'iconfont iconrsuccess') : grid.starred ? 'iconfont iconcrown' : 'iconfont iconrpic'" />
                  </a-button>
                </div>
              </div>
              <div
                v-else
                :class="'griditem ' + listGridMode + ' ' + (panfileStore.ListSelected.has(grid.file_id) ? ' selected' : '') + (panfileStore.ListFocusKey == grid.file_id ? ' focus' : '')"
                @click="handleSelect(grid.file_id, $event)"
                @mouseover="() => onSelectRang(grid.file_id)"
                @contextmenu="(event:MouseEvent)=>handleRightClick({event,node:{key:grid.file_id}} )"
                draggable="true"
                @dragstart="(ev) => onRowItemDragStart(ev, grid.file_id)"
                @dragend="onRowItemDragEnd"
              >
                <div class="gridicon">
                  <i :class="'iconfont ' + grid.icon" aria-hidden="true" role="img"></i>
                </div>
                <div class="gridicon"><img v-if="grid.thumbnail" :src="grid.thumbnail" @error="(e) => {(e.currentTarget! as any).style.display = 'none'}" /></div>

                <div class="gridicon">
                  <span v-if="grid.category.startsWith('video')" class="playicon" @click="handleOpenFile($event, grid)">
                    <svg viewBox="0 0 1024 1024">
                      <path d="M689.066667 480l-196.266667-177.066667c-27.733333-25.6-70.4-6.4-70.4 32v356.266667c0 36.266667 44.8 55.466667 70.4 32l196.266667-177.066667c17.066667-19.2 17.066667-49.066667 0-66.133333z"></path>
                    </svg>
                  </span>
                  <span v-else></span>
                </div>

                <div class="gridname">
                  <div @click="handleOpenFile($event, grid)" :class="'filecolor ' + grid.description" :title="grid.sizestr + ' ' + grid.name">
                    {{ grid.name }}
                  </div>
                </div>

                <div class="gridinfo">{{ grid.timestr }}</div>

                <div :class="'rangselect ' + (rangSelectFiles[grid.file_id] ? (rangSelectStart == grid.file_id ? 'rangstart' : rangSelectEnd == grid.file_id ? 'rangend' : 'rang') : '')">
                  <a-button shape="circle" type="text" tabindex="-1" class="select" :title="index * listGridColumn + gindex" @click.prevent.stop="handleSelect(grid.file_id, { ctrlKey: true, shiftKey: false })">
                    <i :class="panfileStore.ListSelected.has(grid.file_id) ? (grid.starred ? 'iconfont iconcrown3' : 'iconfont iconrsuccess') : grid.starred ? 'iconfont iconcrown' : 'iconfont iconrpic'" />
                  </a-button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </a-list>

    <a-list
      v-else
      ref="viewlist"
      :bordered="false"
      :split="false"
      :max-height="winStore.GetListHeightNumber"
      :virtualListProps="{
        height: winStore.GetListHeightNumber,
        isStaticItemHeight: true,
        estimatedItemHeight: 260,
        threshold: 1,
        itemKey: 'file_id'
      }"
      style="width: 100%"
      :data="panfileStore.ListDataGrid"
      tabindex="-1"
      @scroll="onHideRightMenuScroll"
    >
      <template #item="{ item, index }">
        <div :key="'g-' + item.file_id" class="listitemdiv" :data-id="item.file_id">
          <div class="gridrow" :style="{ gridTemplateColumns: 'repeat(' + listGridColumn + ', 200px)' }">
            <template v-for="(grid, gindex) in item.files">
              <div
                v-if="grid.isdir"
                :class="'griditem ' + listGridMode + ' ' + (panfileStore.ListSelected.has(grid.file_id) ? ' selected' : '') + (panfileStore.ListFocusKey == grid.file_id ? ' focus' : '')"
                @click="handleSelect(grid.file_id, $event)"
                @mouseover="() => onSelectRang(grid.file_id)"
                @contextmenu="(event:MouseEvent)=>handleRightClick({event,node:{key:grid.file_id}} )"
                draggable="true"
                @dragstart="(ev) => onRowItemDragStart(ev, grid.file_id)"
                @dragend="onRowItemDragEnd"
                @drop="onRowItemDrop($event, grid.file_id)"
                @dragover="onRowItemDragOver"
                @dragenter="onRowItemDragEnter"
                @dragleave="onRowItemDragLeave"
              >
                <div class="gridicon">
                  <i :class="'iconfont ' + grid.icon" aria-hidden="true" role="img"></i>
                </div>
                <div class="gridicon"><img v-if="grid.thumbnail" :src="grid.thumbnail" @error="(e) => {(e.currentTarget! as any).style.display = 'none'}" /></div>

                <div class="gridicon">
                  <span v-if="grid.category.startsWith('video')" class="playicon" @click="handleOpenFile($event, grid)">
                    <svg viewBox="0 0 1024 1024">
                      <path d="M689.066667 480l-196.266667-177.066667c-27.733333-25.6-70.4-6.4-70.4 32v356.266667c0 36.266667 44.8 55.466667 70.4 32l196.266667-177.066667c17.066667-19.2 17.066667-49.066667 0-66.133333z"></path>
                    </svg>
                  </span>
                  <span v-else></span>
                </div>

                <div class="gridname">
                  <div @click="handleOpenFile($event, grid)" :class="'filecolor ' + grid.description" :title="grid.sizestr + ' ' + grid.name">
                    {{ grid.name }}
                  </div>
                </div>

                <div class="gridinfo">{{ grid.timestr }}</div>

                <div :class="'rangselect ' + (rangSelectFiles[grid.file_id] ? (rangSelectStart == grid.file_id ? 'rangstart' : rangSelectEnd == grid.file_id ? 'rangend' : 'rang') : '')">
                  <a-button shape="circle" type="text" tabindex="-1" class="select" :title="index * listGridColumn + gindex" @click.prevent.stop="handleSelect(grid.file_id, { ctrlKey: true, shiftKey: false })">
                    <i :class="panfileStore.ListSelected.has(grid.file_id) ? (grid.starred ? 'iconfont iconcrown3' : 'iconfont iconrsuccess') : grid.starred ? 'iconfont iconcrown' : 'iconfont iconrpic'" />
                  </a-button>
                </div>
              </div>
              <div
                v-else
                :class="'griditem ' + listGridMode + ' ' + (panfileStore.ListSelected.has(grid.file_id) ? ' selected' : '') + (panfileStore.ListFocusKey == grid.file_id ? ' focus' : '')"
                @click="handleSelect(grid.file_id, $event)"
                @mouseover="() => onSelectRang(grid.file_id)"
                @contextmenu="(event:MouseEvent)=>handleRightClick({event,node:{key:grid.file_id}} )"
                draggable="true"
                @dragstart="(ev) => onRowItemDragStart(ev, grid.file_id)"
                @dragend="onRowItemDragEnd"
              >
                <div class="gridicon">
                  <i :class="'iconfont ' + grid.icon" aria-hidden="true" role="img"></i>
                </div>
                <div class="gridicon"><img v-if="grid.thumbnail" :src="grid.thumbnail" @error="(e) => {(e.currentTarget! as any).style.display = 'none'}" /></div>

                <div class="gridicon">
                  <span v-if="grid.category.startsWith('video')" class="playicon" @click="handleOpenFile($event, grid)">
                    <svg viewBox="0 0 1024 1024">
                      <path d="M689.066667 480l-196.266667-177.066667c-27.733333-25.6-70.4-6.4-70.4 32v356.266667c0 36.266667 44.8 55.466667 70.4 32l196.266667-177.066667c17.066667-19.2 17.066667-49.066667 0-66.133333z"></path>
                    </svg>
                  </span>
                  <span v-else></span>
                </div>

                <div class="gridname">
                  <div @click="handleOpenFile($event, grid)" :class="'filecolor ' + grid.description" :title="grid.sizestr + ' ' + grid.name">
                    {{ grid.name }}
                  </div>
                </div>

                <div class="gridinfo">{{ grid.timestr }}</div>

                <div :class="'rangselect ' + (rangSelectFiles[grid.file_id] ? (rangSelectStart == grid.file_id ? 'rangstart' : rangSelectEnd == grid.file_id ? 'rangend' : 'rang') : '')">
                  <a-button shape="circle" type="text" tabindex="-1" class="select" :title="index * listGridColumn + gindex" @click.prevent.stop="handleSelect(grid.file_id, { ctrlKey: true, shiftKey: false })">
                    <i :class="panfileStore.ListSelected.has(grid.file_id) ? (grid.starred ? 'iconfont iconcrown3' : 'iconfont iconrsuccess') : grid.starred ? 'iconfont iconcrown' : 'iconfont iconrpic'" />
                  </a-button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </a-list>

    <FileRightMenu :dirtype="panfileStore.SelectDirType" :isvideo="menuShowVideo" :isselected="panfileStore.IsListSelected" :isselectedmulti="panfileStore.IsListSelectedMulti" :isallfavored="panfileStore.IsListSelectedFavAll" />
    <TrashRightMenu :dirtype="panfileStore.SelectDirType" />
  </div>

  <div id="PanRightShowUpload" :style="{ display: showDragUpload ? '' : 'none' }" @drop="onPanDrop" @dragover="onPanDragOver" @dragleave="onPanDragLeave" @dragend="onPanDragEnd">
    <div className="ShowUpload">
      <i className="iconfont iconyouxian" style="font-size: 64px" />
      <div className="ShowUploadTitle">
        <span className="link">上传到：{{ panfileStore.DirName }}</span>
      </div>
    </div>
  </div>
</template>

<style>
.arco-dropdown-option-icon {
  margin-right: 2px !important;
  width: 20px;
  flex-grow: 0;
  flex-shrink: 0;
  align-items: center;
}
.arco-dropdown-option-icon .iconfont {
  font-size: 18px;
}

.arco-dropdown-option-content > div {
  line-height: 26px;
  height: 26px;
  display: flex;
}
.arco-dropdown-option {
  padding: 0 4px !important;
}

.arco-btn.gengduo {
  width: 12px;
  height: 28px;
  min-height: 28px;
  margin: 0;
  padding: 2px 0;
  background: transparent;
  border-color: transparent;
  border-radius: 4px;
}

.arco-btn.gengduo .iconfont {
  width: 12px;
  height: 24px;
}

.arco-btn.gengduo .iconfont::before {
  display: inline-block;
  width: 12px;
  height: 24px;
  margin-top: -6px;
  margin-left: -12px;
  font-size: 24px;
}

.popimg {
  padding: 0 !important;
}

.popimg .arco-popover-content {
  margin-top: 0 !important;
}

.rightmenu .arco-dropdown-option {
  line-height: 26px !important;
}
.rightmenu.arco-dropdown-list-wrapper,
.rightmenu .arco-dropdown-list-wrapper {
  max-height: 300px !important;
  overflow-y: auto;
}

.draging .fileitem.selected,
.draging .griditem.selected {
  opacity: 0.6;
}
.draging .fileitem *,
.draging .griditem *,
.ranging .fileitem *,
.ranging .griditem * {
  pointer-events: none;
}

.pandraging {
  pointer-events: none;
}

#PanRightShowUpload {
  position: fixed;
  z-index: 2000;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  display: flex;
  align-items: flex-end;
  justify-content: flex-end;
  background-image: linear-gradient(to top, rgba(120, 115, 245, 0.3) 0%, rgba(120, 115, 245, 0.06) 22%, rgba(236, 119, 171, 0.01) 80%);
}
#PanRightShowUpload .ShowUpload {
  max-width: 80%;
  margin: 16px auto 48px auto;
  overflow: hidden;
  text-align: center;
  pointer-events: none;
}

#PanRightShowUpload .ShowUpload .ShowUploadTitle {
  margin: 0 auto;
  padding: 4px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 6px;
}
#PanRightShowUpload .ShowUpload .link {
  overflow: hidden;
  color: #1976d2;
  font-size: 14px;
  white-space: nowrap !important;
  text-overflow: ellipsis;
  word-break: keep-all !important;
}
#PanRightShowUpload .ShowUpload .iconfont {
  color: rgb(120, 115, 245);
}
.fileorder .arco-btn-size-small {
  padding: 0 4px;
  display: inline-flex;
  align-items: center;
  min-width: 102px;
}
.fileorder .iconfont {
  font-size: 18px;
  line-height: 24px;
}
</style>
